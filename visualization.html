<head>
  <style> body { margin: 0; } </style>

  <script src="//unpkg.com/force-graph"></script>
  <script src="//unpkg.com/d3-quadtree"></script>
  <script src="//unpkg.com/d3-force"></script>
  <script src="//unpkg.com/d3-bboxCollide"></script>
  <!-- <script src="/example/custom-node-shape/collide.js"></script> -->
  <!--<script src="../../dist/force-graph.js"></script>-->
</head>

<body>
  <div id="graph"></div>

  <script>

function linkExist(sourceTargetTuples,kinaseID,targetID){
  for (let idx = 0; idx < sourceTargetTuples.length; idx++) {
    currTuple = sourceTargetTuples[idx]
    if (currTuple[0] === kinaseID && currTuple[1] === targetID){
      return true
    }
  }
return false
}

function parseCSV(file_name) {
let dict = {"nodes": [], "links": []}

var userData = JSON.parse(window.localStorage.getItem(file_name));
for (let i = 0; i < userData.length; i++) {
  dataLine = userData[i]
  kinaseID =  dataLine['KinaseID']
  kinaseSize = dataLine['KinaseSize']
  kinaseActivity = dataLine['KinaseActivity']
  edgeWeight = dataLine['EdgeWeight']
  edgeColor = dataLine['EdgeColor']
  targetID = dataLine['TargetID']
  targetSize = dataLine['TargetSize']
  diffPhos = dataLine['log2FC']
  PhosphoSiteID = dataLine['PhosphoSiteID']
  pValue = dataLine['pValue']

  currentNodeList = dict["nodes"].map(el => el.id)

  //kinase is type 1, target is type 2
  if (!(currentNodeList.includes(kinaseID))){ // if kinase id does not occur in nodes
    dict["nodes"].push({'id': kinaseID, "type": 1, "kinaseActivity":kinaseActivity, "nodeSize": kinaseSize, "nodeColors": [], "partitionIDs":[], "pValues":[]})
    currentNodeList.push(kinaseID)
  }
  else { // kinase id occurs, need to check if it is labeled as target and change its type into kinase (1)
    nodeIndex = currentNodeList.indexOf(kinaseID)
    dict['nodes'][nodeIndex]['type'] = 1
  }

  if (!(currentNodeList.includes(targetID))){
    let currentNodeColors = []
    if(diffPhos!=undefined){currentNodeColors.push(diffPhos)}
    let currentNodePartitions = []
    if(PhosphoSiteID!=undefined){currentNodePartitions.push(PhosphoSiteID)}
    let currentpValues = []
    if(pValue!=undefined){currentpValues.push(pValue)}
    dict["nodes"].push({'id': targetID, "type": 2, "kinaseActivity":0, "nodeSize": targetSize, "nodeColors": currentNodeColors, "partitionIDs": currentNodePartitions, "pValues": currentpValues})
  }

  else{ // target id occurs again (must need partitions!!!), need to append diffPhos to nodecolors and PhosphoSiteID to partitionIDs
        // no need to update its type as target !!!!!!!!
      nonDirtyNodeList = dict["nodes"].map(el => el.id)
      nodeIndex = nonDirtyNodeList.indexOf(targetID)
      if(PhosphoSiteID != undefined && !(dict['nodes'][nodeIndex]['partitionIDs'].includes(PhosphoSiteID))){
        dict['nodes'][nodeIndex]['partitionIDs'].push(PhosphoSiteID)
        if(diffPhos!=undefined){dict['nodes'][nodeIndex]['nodeColors'].push(diffPhos)}
        if(pValue!=undefined){ dict['nodes'][nodeIndex]['pValues'].push(pValue)}
      }
  }

  sourceTargetTuples = dict["links"].map(el => [el.source,el.target])

  if(!(linkExist(sourceTargetTuples,kinaseID,targetID))){
    if(kinaseID===targetID){
      dict['links'].push({'source': kinaseID, 'target': targetID, 'edgeWeight': edgeWeight, 'edgeColor': edgeColor, 'curvature':.4})
    }
    else{
      dict['links'].push({'source': kinaseID, 'target': targetID, 'edgeWeight': edgeWeight, 'edgeColor': edgeColor, 'curvature':0})
    }
  }
}


for(let nodeIndex = 0 ; nodeIndex<dict['nodes'].length; nodeIndex++){

 
    let tempColors = dict['nodes'][nodeIndex]['nodeColors']
    
    indices = Array.from(tempColors.keys()).sort( (a,b) => tempColors[b]-tempColors[a])
        
    dict['nodes'][nodeIndex]['partitionIDs'] = indices.map(i => dict['nodes'][nodeIndex]['partitionIDs'][i])
    dict['nodes'][nodeIndex]['nodeColors'] = indices.map(i => dict['nodes'][nodeIndex]['nodeColors'][i])
    dict['nodes'][nodeIndex]['pValues'] = indices.map(i => dict['nodes'][nodeIndex]['pValues'][i])

    if(dict['nodes'][nodeIndex]['nodeColors'].length>10){
    dict['nodes'][nodeIndex]['partitionIDs'] = [...dict['nodes'][nodeIndex]['partitionIDs'].slice(0,5), ...dict['nodes'][nodeIndex]['partitionIDs'].slice(-5)]
    dict['nodes'][nodeIndex]['nodeColors'] = [...dict['nodes'][nodeIndex]['nodeColors'].slice(0,5), ...dict['nodes'][nodeIndex]['nodeColors'].slice(-5)]
    dict['nodes'][nodeIndex]['pValues'] = [...dict['nodes'][nodeIndex]['pValues'].slice(0,5), ...dict['nodes'][nodeIndex]['pValues'].slice(-5)]
  }

}

dict['ids'] = dict["nodes"].map(el => el.id)

return dict;
}

const CAMERA_DISTANCE2NODES_FACTOR = 170;

var file_names = JSON.parse(localStorage.getItem("file_names"))
var index = localStorage.getItem("idx")
var gData = parseCSV(localStorage.getItem(file_names[index]))

// gData = {
// "nodes": [
// {"id": "AKT1"},
// {"id": "AKT2"},
// {"id": "ATR"},
// {"id": "AURKA"},
// {"id": "CAMK2A"},
// {"id": "CDK1"},
// {"id": "CDK2_kinase"},
// {"id": "CDK4"},
// {"id": "CDK5"},
// {"id": "CHEK1"},
// {"id": "CLK1"},
// {"id": "CSNK2A1"},
// {"id": "DYRK3"},
// {"id": "EEF2K"},
// {"id": "GSK3B_kinase"},
// {"id": "LATS1"},
// {"id": "MAPK1"},
// {"id": "MAPK14"},
// {"id": "MAPK3"},
// {"id": "MAPKAPK2"},
// {"id": "MARK2"},
// {"id": "MASTL"},
// {"id": "MELK"},
// {"id": "MTOR_kinase"},
// {"id": "NEK6"},
// {"id": "PAK1"},
// {"id": "PLK1"},
// {"id": "PRKAA1"},
// {"id": "PRKACA"},
// {"id": "PRKCA"},
// {"id": "PRKCD"},
// {"id": "PRKCI"},
// {"id": "PRKDC_kinase"},
// {"id": "RPS6KB1_kinase"},
// {"id": "RPS6KB2"},
// {"id": "SRC"},
// {"id": "TBK1"},
// {"id": "UHMK1"},
// {"id": "WEE1"},
// {"id": "HSPB1"},
// {"id": "LMNB1"},
// {"id": "TOP2A"},
// {"id": "PSMD11"},
// {"id": "SEPTIN2"},
// {"id": "ECT2"},
// {"id": "NUCKS1"},
// {"id": "HDAC2"},
// {"id": "LMNA"},
// {"id": "LMNB2"},
// {"id": "FLNA"},
// {"id": "STAT1"},
// {"id": "OXSR1"},
// {"id": "CTNNA1"},
// {"id": "NPM1"},
// {"id": "HNRNPH1"},
// {"id": "SRRM2"},
// {"id": "WDR77"},
// {"id": "EZH2"},
// {"id": "PKM"},
// {"id": "ERRFI1"},
// {"id": "NME2"},
// {"id": "NME1"},
// {"id": "PEA15"},
// {"id": "RRAS2"},
// {"id": "FLNC"},
// {"id": "HNRNPA1"},
// {"id": "XRCC6"},
// {"id": "VIM"},
// {"id": "NELFE"},
// {"id": "TNFAIP1"},
// {"id": "CCNH"},
// {"id": "DNMT1"},
// {"id": "CDK2_substrate"},
// {"id": "MCM4"},
// {"id": "PDCD5"},
// {"id": "NCBP1"},
// {"id": "HSP90AB1"},
// {"id": "JPT2"},
// {"id": "SUN2"},
// {"id": "STMN1"},
// {"id": "GFPT1"},
// {"id": "SH3RF1"},
// {"id": "EMD"},
// {"id": "JUNB"},
// {"id": "GSK3B_substrate"},
// {"id": "HNRNPH2"},
// {"id": "YAP1"},
// {"id": "EIF4B"},
// {"id": "ANXA2"},
// {"id": "PTPN1"},
// {"id": "SUZ12"},
// {"id": "AKT1S1"},
// {"id": "NEDD4L"},
// {"id": "DPYSL2"},
// {"id": "RANBP2"},
// {"id": "EEF2"},
// {"id": "RBL2"},
// {"id": "MYH9"},
// {"id": "VCP"},
// {"id": "PRKDC_substrate"},
// {"id": "ABCB1"},
// {"id": "NFKB2"},
// {"id": "ANP32B"},
// {"id": "RCC1"},
// {"id": "SNAPIN"},
// {"id": "ADD3"},
// {"id": "ARNT"},
// {"id": "RB1"},
// {"id": "BAG2"},
// {"id": "ANKLE2"},
// {"id": "EDC3"},
// {"id": "TFPT"},
// {"id": "ATRIP"},
// {"id": "SF1"},
// {"id": "LIG1"},
// {"id": "H1-4"},
// {"id": "TERF2IP"},
// {"id": "CAD"},
// {"id": "HACE1"},
// {"id": "STAT3"},
// {"id": "LSP1"},
// {"id": "RECQL4"},
// {"id": "CTNNB1"},
// {"id": "KIF13B"},
// {"id": "TBC1D1"},
// {"id": "GSK3A"},
// {"id": "ABI1"},
// {"id": "PXN"},
// {"id": "MTOR_substrate"},
// {"id": "NCOA2"},
// {"id": "ACACA"},
// {"id": "SQSTM1"},
// {"id": "CBY1"},
// {"id": "ENSA"},
// {"id": "PFKFB2"},
// {"id": "ZFP36L1"},
// {"id": "LIMA1"},
// {"id": "NUP98"},
// {"id": "MAPRE3"},
// {"id": "ANAPC1"},
// {"id": "RPS6KB1_substrate"},
// {"id": "RRN3"},
// {"id": "CDKN1A"},
// {"id": "MYH10"},
// {"id": "TP53"} 
// ],
// "links": [
// {"source": "MAPKAPK2", "target": "HSPB1"},
// {"source": "CDK1", "target": "LMNB1"},
// {"source": "MAPK3", "target": "TOP2A"},
// {"source": "PRKACA", "target": "PSMD11"},
// {"source": "CSNK2A1", "target": "SEPTIN2"},
// {"source": "PRKCI", "target": "ECT2"},
// {"source": "CDK1", "target": "NUCKS1"},
// {"source": "CSNK2A1", "target": "HDAC2"},
// {"source": "CDK1", "target": "LMNA"},
// {"source": "CDK1", "target": "LMNA"},
// {"source": "CDK2_kinase", "target": "LMNB2"},
// {"source": "CDK1", "target": "FLNA"},
// {"source": "PRKCD", "target": "STAT1"},
// {"source": "MTOR_kinase", "target": "OXSR1"},
// {"source": "CSNK2A1", "target": "CTNNA1"},
// {"source": "ATR", "target": "NPM1"},
// {"source": "CDK2_kinase", "target": "HNRNPH1"},
// {"source": "CDK1", "target": "SRRM2"},
// {"source": "CDK4", "target": "WDR77"},
// {"source": "PRKCI", "target": "EZH2"},
// {"source": "MAPK1", "target": "PKM"},
// {"source": "CHEK1", "target": "ERRFI1"},
// {"source": "CDK1", "target": "NME2"},
// {"source": "CDK1", "target": "NME1"},
// {"source": "AKT1", "target": "PEA15"},
// {"source": "MAPK3", "target": "RRAS2"},
// {"source": "AKT2", "target": "FLNC"},
// {"source": "RPS6KB2", "target": "HNRNPA1"},
// {"source": "CDK2_kinase", "target": "XRCC6"},
// {"source": "MAPKAPK2", "target": "HSPB1"},
// {"source": "PRKDC_kinase", "target": "VIM"},
// {"source": "MAPKAPK2", "target": "NELFE"},
// {"source": "CSNK2A1", "target": "TNFAIP1"},
// {"source": "CSNK2A1", "target": "CCNH"},
// {"source": "MTOR_kinase", "target": "DNMT1"},
// {"source": "WEE1", "target": "CDK2_substrate"},
// {"source": "WEE1", "target": "CDK2_substrate"},
// {"source": "CDK2_kinase", "target": "MCM4"},
// {"source": "CSNK2A1", "target": "PDCD5"},
// {"source": "RPS6KB1_kinase", "target": "NCBP1"},
// {"source": "CSNK2A1", "target": "HSP90AB1"},
// {"source": "CDK2_kinase", "target": "JPT2"},
// {"source": "PRKACA", "target": "SUN2"},
// {"source": "MAPK3", "target": "STMN1"},
// {"source": "PRKAA1", "target": "GFPT1"},
// {"source": "AKT2", "target": "SH3RF1"},
// {"source": "PRKACA", "target": "EMD"},
// {"source": "GSK3B_kinase", "target": "JUNB"},
// {"source": "PRKCD", "target": "GSK3B_substrate"},
// {"source": "CDK2_kinase", "target": "HNRNPH2"},
// {"source": "CDK1", "target": "YAP1"},
// {"source": "CHEK1", "target": "SRRM2"},
// {"source": "MELK", "target": "EIF4B"},
// {"source": "SRC", "target": "ANXA2"},
// {"source": "CLK1", "target": "PTPN1"},
// {"source": "PLK1", "target": "SUZ12"},
// {"source": "DYRK3", "target": "AKT1S1"},
// {"source": "PRKACA", "target": "NEDD4L"},
// {"source": "CDK5", "target": "DPYSL2"},
// {"source": "GSK3B_kinase", "target": "DPYSL2"},
// {"source": "CDK1", "target": "NPM1"},
// {"source": "CDK1", "target": "RANBP2"},
// {"source": "LATS1", "target": "YAP1"},
// {"source": "EEF2K", "target": "EEF2"},
// {"source": "CDK4", "target": "RBL2"},
// {"source": "CSNK2A1", "target": "MYH9"},
// {"source": "AKT1", "target": "VCP"},
// {"source": "PRKDC_kinase", "target": "PRKDC_substrate"},
// {"source": "CSNK2A1", "target": "TOP2A"},
// {"source": "MELK", "target": "EIF4B"},
// {"source": "PRKACA", "target": "ABCB1"},
// {"source": "GSK3B_kinase", "target": "NFKB2"},
// {"source": "CSNK2A1", "target": "ANP32B"},
// {"source": "CDK1", "target": "RCC1"},
// {"source": "CDK2_kinase", "target": "SNAPIN"},
// {"source": "CHEK1", "target": "ADD3"},
// {"source": "PRKDC_kinase", "target": "VIM"},
// {"source": "CSNK2A1", "target": "ARNT"},
// {"source": "CDK1", "target": "VIM"},
// {"source": "CDK2_kinase", "target": "RB1"},
// {"source": "MAPKAPK2", "target": "BAG2"},
// {"source": "CDK2_kinase", "target": "ANKLE2"},
// {"source": "AKT2", "target": "EDC3"},
// {"source": "CDK1", "target": "TFPT"},
// {"source": "CDK2_kinase", "target": "ATRIP"},
// {"source": "MAPKAPK2", "target": "NELFE"},
// {"source": "UHMK1", "target": "SF1"},
// {"source": "UHMK1", "target": "SF1"},
// {"source": "CHEK1", "target": "LIG1"},
// {"source": "CSNK2A1", "target": "LIG1"},
// {"source": "CDK1", "target": "H1-4"},
// {"source": "CDK2_kinase", "target": "TERF2IP"},
// {"source": "PRKACA", "target": "CAD"},
// {"source": "PAK1", "target": "HACE1"},
// {"source": "PRKCA", "target": "ANXA2"},
// {"source": "PRKCD", "target": "STAT3"},
// {"source": "MAPKAPK2", "target": "LSP1"},
// {"source": "CDK1", "target": "RECQL4"},
// {"source": "CDK2_kinase", "target": "MCM4"},
// {"source": "CAMK2A", "target": "CTNNB1"},
// {"source": "MARK2", "target": "KIF13B"},
// {"source": "CDK1", "target": "RB1"},
// {"source": "PRKAA1", "target": "TBC1D1"},
// {"source": "PRKCD", "target": "GSK3A"},
// {"source": "MAPK3", "target": "ABI1"},
// {"source": "MAPK14", "target": "PXN"},
// {"source": "RPS6KB1_kinase", "target": "MTOR_substrate"},
// {"source": "CSNK2A1", "target": "NCOA2"},
// {"source": "PRKACA", "target": "VIM"},
// {"source": "PRKAA1", "target": "ACACA"},
// {"source": "CDK1", "target": "SQSTM1"},
// {"source": "CDK1", "target": "SQSTM1"},
// {"source": "CDK1", "target": "NPM1"},
// {"source": "AKT2", "target": "CBY1"},
// {"source": "MASTL", "target": "ENSA"},
// {"source": "AKT1", "target": "PFKFB2"},
// {"source": "MAPKAPK2", "target": "ZFP36L1"},
// {"source": "MAPK3", "target": "LIMA1"},
// {"source": "PRKCA", "target": "VIM"},
// {"source": "NEK6", "target": "NUP98"},
// {"source": "AURKA", "target": "MAPRE3"},
// {"source": "CDK1", "target": "ANAPC1"},
// {"source": "TBK1", "target": "RPS6KB1_substrate"},
// {"source": "CDK2_kinase", "target": "RRN3"},
// {"source": "MAPK3", "target": "CDKN1A"},
// {"source": "PRKCA", "target": "VIM"},
// {"source": "CSNK2A1", "target": "MYH10"},
// {"source": "PRKACA", "target": "VIM"},
// {"source": "CAMK2A", "target": "STMN1"},
// {"source": "AURKA", "target": "TP53"},
// {"source": "MAPK3", "target": "STMN1"},
//   ]
//     }

    // // get a number persistent color from around the palette
    // const getColor = n => '#' + ((n * 1234567) % Math.pow(2, 24)).toString(16).padStart(6, '0');

    var rectangleCollide = d3.bboxCollide([[-7,-10],[7,10]])

    const Graph = ForceGraph()
      (document.getElementById('graph'))
        // .nodeCanvasObject((node, ctx) => nodePaint(node, getColor(node.id), ctx))
        .nodeCanvasObject((node, ctx) => {
          const label = node.id;

          ctx.fillStyle = '#0000ff';
          ctx.fillRect(node.x - 6, node.y - 3, 12, 6);
          ctx.fillStyle = '#cccccc';
          ctx.fillRect(node.x - 6, node.y + 3, 12, 6);
          ctx.fillStyle = '#ff2b2b';
          ctx.fillRect(node.x - 6, node.y + 9, 12, 6);
          
        })
        .nodePointerAreaPaint(nodePaint)
        .nodeId('id')
        .nodeLabel('id')
        .graphData(gData);

        Graph.d3Force('collide', rectangleCollide);
        Graph.d3Force('charge').strength(-70);
        // Graph.d3Force('link').distance(link => 70);


    function nodePaint({ id, x, y }, color, ctx) {
      ctx.fillStyle = color
      ctx.fillRect(x-6, y-3, 12, 18);
    }


  </script>
</body>